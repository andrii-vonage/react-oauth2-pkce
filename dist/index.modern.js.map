{"version":3,"file":"index.modern.js","sources":["../src/AuthContext.tsx","../src/AuthProvider.tsx","../src/pkce.ts","../src/util.ts","../src/AuthService.ts"],"sourcesContent":["import React, { useContext, ReactElement } from 'react'\n\nimport { AuthServiceProps, AuthService } from './AuthService'\n\nexport type AuthContextProps = {\n  authService: AuthService\n}\n\nexport type AuthContextType = AuthContextProps | undefined\n\nexport const AuthContext = React.createContext<AuthContextProps | undefined>(\n  undefined\n)\n\nexport const useAuth = (): AuthContextProps => {\n  const context = useContext(AuthContext)\n  if (context === undefined) {\n    throw new Error('useAuth must be used within a AuthProvider')\n  }\n  return context\n}\n\nexport function withAuth<T>(\n  ComponentToWrap: React.ComponentType<T & AuthServiceProps>\n): React.FC<T & AuthServiceProps> {\n  const WrappedComponent = (props: T & AuthServiceProps): ReactElement => {\n    const authProps = useAuth()\n    return <ComponentToWrap {...authProps} {...props} />\n  }\n  WrappedComponent.displayName =\n    'withAuth_' + (ComponentToWrap.displayName || ComponentToWrap.name)\n  return WrappedComponent\n}\n","import React, { ReactElement, ReactNode } from 'react'\n\nimport { AuthService } from './AuthService'\nimport { AuthContext } from './AuthContext'\n\ninterface AuthProviderProps {\n  children: ReactNode\n  authService: AuthService\n}\n\nexport const AuthProvider = (props: AuthProviderProps): ReactElement => {\n  const { authService, children } = props\n\n  return (\n    <AuthContext.Provider value={{ authService }}>\n      {children}\n    </AuthContext.Provider>\n  )\n}\n","import createHash from 'create-hash'\nimport randomBytes from 'randombytes'\n\nexport type PKCECodePair = {\n  codeVerifier: string\n  codeChallenge: string\n  createdAt: Date\n}\n\nexport const base64URLEncode = (str: Buffer): string => {\n  return str\n    .toString('base64')\n    .replace(/\\+/g, '-')\n    .replace(/\\//g, '_')\n    .replace(/=/g, '')\n}\n\nexport const sha256 = (buffer: Buffer): Buffer => {\n  return createHash('sha256').update(buffer).digest()\n}\n\nexport const createPKCECodes = (): PKCECodePair => {\n  const codeVerifier = base64URLEncode(randomBytes(64))\n  const codeChallenge = base64URLEncode(sha256(Buffer.from(codeVerifier)))\n  const createdAt = new Date()\n  const codePair = {\n    codeVerifier,\n    codeChallenge,\n    createdAt\n  }\n  return codePair\n}\n","export const toSnakeCase = (str: string): string => {\n  return str\n    .split(/(?=[A-Z])/)\n    .join('_')\n    .toLowerCase()\n}\n\nexport const toUrlEncoded = (obj: {}): string => {\n  return Object.keys(obj)\n    .map(\n      (k) =>\n        encodeURIComponent(toSnakeCase(k)) + '=' + encodeURIComponent(obj[k])\n    )\n    .join('&')\n}\n","/* eslint-disable @typescript-eslint/camelcase */\nimport { createPKCECodes, PKCECodePair, base64URLEncode } from './pkce'\nimport { toUrlEncoded } from './util'\nimport randomBytes from 'randombytes'\n\nimport jwtDecode from 'jwt-decode'\n\nexport interface AuthServiceProps {\n  clientId: string\n  clientSecret?: string\n  contentType?: string\n  location: Location\n  provider: string\n  authorizeEndpoint?: string\n  tokenEndpoint?: string\n  logoutEndpoint?: string\n  audience?: string\n  redirectUri?: string\n  scopes: string[]\n  autoRefresh?: boolean\n  refreshSlack?: number\n}\n\nexport interface AuthTokens {\n  id_token: string\n  access_token: string\n  refresh_token: string\n  expires_in: number\n  expires_at?: number // calculated on login\n  token_type: string\n}\n\nexport interface JWTIDToken {\n  given_name: string\n  family_name: string\n  name: string\n  email: string\n}\n\nexport interface TokenRequestBody {\n  clientId: string\n  grantType: string\n  redirectUri?: string\n  refresh_token?: string\n  clientSecret?: string\n  code?: string\n  codeVerifier?: string\n}\n\nexport class AuthService<TIDToken = JWTIDToken> {\n  props: AuthServiceProps\n  timeout?: number\n  authListener?: (auth: AuthTokens) => void\n\n  constructor(props: AuthServiceProps) {\n    this.props = props\n    const code = this.getCodeFromLocation(window.location)\n    if (code !== null) {\n      this.fetchToken(code)\n        .then(() => {\n          this.restoreUri()\n        })\n        .catch((e) => {\n          this.removeItem('pkce')\n          this.removeItem('auth')\n          this.removeCodeFromLocation()\n          console.warn({ e })\n        })\n    } else if (this.props.autoRefresh) {\n      this.startTimer()\n    }\n  }\n\n  getUser(): {} {\n    const t = this.getAuthTokens()\n    if (null === t) return {}\n    const decoded = jwtDecode(t.id_token) as TIDToken\n    return decoded\n  }\n\n  getCodeFromLocation(location: Location): string | null {\n    const split = location.toString().split('?')\n    if (split.length < 2) {\n      return null\n    }\n    const pairs = split[1].split('&')\n    for (const pair of pairs) {\n      const [key, value] = pair.split('=')\n      if (key === 'code') {\n        return decodeURIComponent(value || '')\n      }\n    }\n    return null\n  }\n\n  removeCodeFromLocation(): void {\n    const [base, search] = window.location.href.split('?')\n    if (!search) {\n      return\n    }\n    const newSearch = search\n      .split('&')\n      .map((param) => param.split('='))\n      .filter(([key]) => key !== 'code')\n      .map((keyAndVal) => keyAndVal.join('='))\n      .join('&')\n    window.history.replaceState(\n      window.history.state,\n      'null',\n      base + (newSearch.length ? `?${newSearch}` : '')\n    )\n  }\n\n  getItem(key: string): string | null {\n    return window.localStorage.getItem(key)\n  }\n  removeItem(key: string): void {\n    window.localStorage.removeItem(key)\n  }\n\n  getPkce(): PKCECodePair {\n    const pkce = window.localStorage.getItem('pkce')\n    if (null === pkce) {\n      throw new Error('PKCE pair not found in local storage')\n    } else {\n      return JSON.parse(pkce)\n    }\n  }\n\n  setAuthTokens(auth: AuthTokens): void {\n    const { refreshSlack = 5 } = this.props\n    const now = new Date().getTime()\n    auth.expires_at = now + (+auth.expires_in + refreshSlack) * 1000\n    window.localStorage.setItem('auth', JSON.stringify(auth))\n    if (this.authListener) {\n      this.authListener(auth)\n    }\n  }\n\n  setAuthListener(authListener: (auth: AuthTokens) => void): void {\n    this.authListener = authListener\n  }\n\n  getAuthTokens(): AuthTokens {\n    return JSON.parse(window.localStorage.getItem('auth') || '{}')\n  }\n\n  isPending(): boolean {\n    return (\n      window.localStorage.getItem('pkce') !== null &&\n      window.localStorage.getItem('auth') === null\n    )\n  }\n\n  isAuthenticated(): boolean {\n    const auth = window.localStorage.getItem('auth')\n\n    if (!auth) {\n      return false\n    }\n\n    const { access_token, error } = JSON.parse(auth)\n\n    return Boolean(access_token) && !error\n  }\n\n  async logout(shouldEndSession = false): Promise<boolean> {\n    this.removeItem('pkce')\n    this.removeItem('auth')\n    if (shouldEndSession) {\n      const { clientId, provider, logoutEndpoint, redirectUri } = this.props\n      const query = {\n        client_id: clientId,\n        post_logout_redirect_uri: redirectUri\n      }\n      const url = `${logoutEndpoint || `${provider}/logout`}?${toUrlEncoded(\n        query\n      )}`\n      window.location.replace(url)\n      return true\n    } else {\n      window.location.reload()\n      return true\n    }\n  }\n\n  async login(): Promise<void> {\n    this.authorize()\n  }\n\n  // this will do a full page reload and to to the OAuth2 provider's login page and then redirect back to redirectUri\n  authorize(): boolean {\n    const {\n      clientId,\n      provider,\n      authorizeEndpoint,\n      redirectUri,\n      scopes,\n      audience\n    } = this.props\n\n    const pkce = createPKCECodes()\n    const state = base64URLEncode(randomBytes(16))\n    window.localStorage.setItem('pkce_state', state)\n    window.localStorage.setItem('pkce', JSON.stringify(pkce))\n    window.localStorage.setItem('preAuthUri', location.href)\n    window.localStorage.removeItem('auth')\n    const codeChallenge = pkce.codeChallenge\n\n    const query = {\n      clientId,\n      scope: scopes.join(' '),\n      responseType: 'code',\n      redirectUri,\n      ...(audience && { audience }),\n      codeChallenge,\n      codeChallengeMethod: 'S256',\n      state\n    }\n    // Responds with a 302 redirect\n    const url = `${authorizeEndpoint || `${provider}/authorize`}?${toUrlEncoded(\n      query\n    )}`\n    window.location.replace(url)\n    return true\n  }\n\n  // this happens after a full page reload. Read the code from localstorage\n  async fetchToken(code: string, isRefresh = false): Promise<AuthTokens> {\n    const {\n      clientId,\n      clientSecret,\n      contentType,\n      provider,\n      tokenEndpoint,\n      redirectUri,\n      autoRefresh = true\n    } = this.props\n    const grantType = 'authorization_code'\n\n    let payload: TokenRequestBody = {\n      clientId,\n      ...(clientSecret ? { clientSecret } : {}),\n      redirectUri,\n      grantType\n    }\n    if (isRefresh) {\n      payload = {\n        ...payload,\n        grantType: 'refresh_token',\n        refresh_token: code\n      }\n    } else {\n      const pkce: PKCECodePair = this.getPkce()\n      const codeVerifier = pkce.codeVerifier\n      payload = {\n        ...payload,\n        code,\n        codeVerifier\n      }\n    }\n\n    const retry = this.getItem('auth_retry')\n    const response = await fetch(`${tokenEndpoint || `${provider}/token`}`, {\n      headers: {\n        'Content-Type': contentType || 'application/x-www-form-urlencoded'\n      },\n      method: 'POST',\n      body: toUrlEncoded(payload)\n    })\n    if (isRefresh && !response.ok) {\n      if (retry === 'true') {\n        this.removeItem('auth_retry')\n      } else {\n        window.localStorage.setItem('auth_retry', 'true')\n        await this.logout()\n        await this.login()\n      }\n    }\n    this.removeItem('pkce')\n    const json = await response.json()\n\n    // \"invalid_grant\" error workaround\n    if (json.error === 'invalid_grant') {\n      if (retry === 'true') {\n        this.removeItem('auth_retry')\n      } else {\n        window.localStorage.setItem('auth_retry', 'true')\n        await this.logout()\n        await this.login()\n      }\n    }\n\n    if (isRefresh && !json.refresh_token) {\n      json.refresh_token = payload.refresh_token\n    }\n    if (json.state && json.state !== this.getItem('pkce_state')) {\n      console.warn(`State ${json.state} doesn't match`)\n    }\n\n    this.removeItem('pkce_state')\n    this.setAuthTokens(json as AuthTokens)\n    if (autoRefresh) {\n      this.startTimer()\n    }\n\n    return this.getAuthTokens()\n  }\n\n  armRefreshTimer(refreshToken: string, timeoutDuration: number): void {\n    if (this.timeout) {\n      clearTimeout(this.timeout)\n    }\n    this.timeout = window.setTimeout(() => {\n      this.fetchToken(refreshToken, true)\n        .then(({ refresh_token: newRefreshToken, expires_at: expiresAt }) => {\n          if (!expiresAt) return\n          const now = new Date().getTime()\n          const timeout = expiresAt - now\n          if (timeout > 0) {\n            this.armRefreshTimer(newRefreshToken, timeout)\n          } else {\n            this.removeItem('auth')\n            this.removeCodeFromLocation()\n          }\n        })\n        .catch((e) => {\n          this.removeItem('auth')\n          this.removeCodeFromLocation()\n          console.warn({ e })\n        })\n    }, timeoutDuration)\n  }\n\n  startTimer(): void {\n    const authTokens = this.getAuthTokens()\n    if (!authTokens) {\n      return\n    }\n    const { refresh_token: refreshToken, expires_at: expiresAt } = authTokens\n    if (!expiresAt || !refreshToken) {\n      return\n    }\n    const now = new Date().getTime()\n    const timeout = expiresAt - now\n    if (timeout > 0) {\n      this.armRefreshTimer(refreshToken, timeout)\n    } else {\n      this.removeItem('auth')\n      this.removeCodeFromLocation()\n    }\n  }\n\n  restoreUri(): void {\n    const uri = window.localStorage.getItem('preAuthUri')\n    window.localStorage.removeItem('preAuthUri')\n    console.log({ uri })\n    if (uri !== null) {\n      window.location.replace(uri)\n    }\n    this.removeCodeFromLocation()\n  }\n}\n"],"names":["AuthContext","React","createContext","undefined","useAuth","context","useContext","Error","withAuth","ComponentToWrap","WrappedComponent","props","authProps","displayName","name","AuthProvider","authService","children","Provider","value","base64URLEncode","str","toString","replace","sha256","buffer","createHash","update","digest","createPKCECodes","codeVerifier","randomBytes","codeChallenge","Buffer","from","createdAt","Date","codePair","toSnakeCase","split","join","toLowerCase","toUrlEncoded","obj","Object","keys","map","k","encodeURIComponent","AuthService","code","getCodeFromLocation","window","location","fetchToken","then","restoreUri","e","removeItem","removeCodeFromLocation","console","warn","autoRefresh","startTimer","getUser","t","getAuthTokens","decoded","jwtDecode","id_token","length","pairs","pair","key","decodeURIComponent","href","base","search","newSearch","param","filter","keyAndVal","history","replaceState","state","getItem","localStorage","getPkce","pkce","JSON","parse","setAuthTokens","auth","refreshSlack","now","getTime","expires_at","expires_in","setItem","stringify","authListener","setAuthListener","isPending","isAuthenticated","access_token","error","Boolean","logout","shouldEndSession","clientId","provider","logoutEndpoint","redirectUri","query","client_id","post_logout_redirect_uri","url","reload","login","authorize","authorizeEndpoint","scopes","audience","scope","responseType","codeChallengeMethod","isRefresh","clientSecret","contentType","tokenEndpoint","grantType","payload","refresh_token","retry","fetch","headers","method","body","response","json","ok","armRefreshTimer","refreshToken","timeoutDuration","timeout","clearTimeout","setTimeout","newRefreshToken","expiresAt","authTokens","uri","log"],"mappings":"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"}